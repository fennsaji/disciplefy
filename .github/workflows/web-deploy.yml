name: Frontend Deployment - Web & Mobile

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'web'
        type: choice
        options:
        - web
        - android
        - ios
        - all

concurrency:
  group: frontend-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.1'

jobs:
  build-web:
    name: Build Flutter Web
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'web' || github.event.inputs.platform == 'all' || github.event.inputs.platform == ''
    timeout-minutes: 20
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          frontend/.dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('frontend/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
        
    - name: Get Flutter dependencies
      working-directory: ./frontend
      run: flutter pub get
      
    - name: Build Web App (Release)
      working-directory: ./frontend
      run: |
        echo "ðŸ”¨ Building Flutter Web app for production..."
        
        flutter build web \
          --release \
          --web-renderer canvaskit \
          --base-href "/" \
          --dart-define=FLUTTER_WEB_BUILD=true \
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          
        echo "âœ… Web build completed successfully"
        
        # Optimize CSP headers for Supabase Storage
        echo "ðŸ”§ Optimizing CSP headers..."
        if [ -f "scripts/optimize_csp.sh" ]; then
          chmod +x scripts/optimize_csp.sh
          ./scripts/optimize_csp.sh
        else
          echo "âš ï¸ CSP optimization script not found, using default CSP from template..."
        fi
        
        # Display build size
        echo "ðŸ“¦ Build size information:"
        du -sh build/web/
        
    - name: Optimize Web Build
      working-directory: ./frontend
      run: |
        echo "âš¡ Optimizing web build..."
        
        # Compress assets if gzip is available
        if command -v gzip &> /dev/null; then
          find build/web -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) -exec gzip -k {} \;
          echo "âœ… Assets compressed with gzip"
        fi
        
        # Show final build structure
        echo "ðŸ“ Final build structure:"
        ls -la build/web/
        
    - name: Upload Web build artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-web-build
        path: frontend/build/web/
        retention-days: 30
        compression-level: 6

  deploy-web:
    name: Deploy Web to Hosting
    runs-on: ubuntu-latest
    needs: build-web
    if: github.ref == 'refs/heads/main' && (github.event.inputs.platform == 'web' || github.event.inputs.platform == 'all' || github.event.inputs.platform == '')
    timeout-minutes: 10
    environment: production
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Web build
      uses: actions/download-artifact@v4
      with:
        name: flutter-web-build
        path: ./web-build
        
    - name: Setup Node.js for deployment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Supabase CLI
      run: npm install -g supabase@1.123.4
      
    - name: Deploy to Supabase Storage
      run: |
        echo "ðŸŒ Deploying to Supabase Storage..."
        
        # Verify web build contents
        echo "ðŸ“ Web build contents:"
        ls -la web-build/
        
        echo "ðŸ“Š Build size analysis:"
        du -sh web-build/*
        
        # Deploy to Supabase Storage
        echo "ðŸš€ Uploading to Supabase Storage..."
        
        cd web-build
        supabase storage cp . ss://disciplefy/ \
          --recursive \
          --cache-control "max-age=3600" \
          --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}" \
          --experimental
        
        echo "âœ… Deployment completed successfully"
        
        # Output deployment URL
        echo "ðŸŒ App deployed at: https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/storage/v1/object/public/disciplefy/index.html"
        
        # Test deployment
        echo "ðŸ” Testing deployment..."
        response=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/storage/v1/object/public/disciplefy/index.html")
        
        if [ "$response" = "200" ]; then
          echo "âœ… Deployment test successful (HTTP $response)"
        else
          echo "âš ï¸ Deployment test returned HTTP $response"
        fi
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-web, build-android, build-ios, deploy-web]
    if: always()
    
    steps:
    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-web.result }}" = "success" ]; then
          echo "âœ… **Web Build**: Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-web.result }}" = "skipped" ]; then
          echo "â­ï¸ **Web Build**: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Web Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-android.result }}" = "success" ]; then
          echo "âœ… **Android Build**: Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-android.result }}" = "skipped" ]; then
          echo "â­ï¸ **Android Build**: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Android Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-ios.result }}" = "success" ]; then
          echo "âœ… **iOS Build**: Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-ios.result }}" = "skipped" ]; then
          echo "â­ï¸ **iOS Build**: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **iOS Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy-web.result }}" = "success" ]; then
          echo "âœ… **Web Deployment**: Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-web.result }}" = "skipped" ]; then
          echo "â­ï¸ **Web Deployment**: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Web Deployment**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Check the **Actions** tab for downloadable build artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Artifacts are retained for 30 days" >> $GITHUB_STEP_SUMMARY