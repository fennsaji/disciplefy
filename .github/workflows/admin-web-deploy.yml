name: Admin Web Production Deployment

on:
  push:
    branches: [main]
    paths:
      - 'admin-web/**'
      - '.github/workflows/admin-web-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_to_vercel:
        description: 'Deploy to Vercel Production'
        required: false
        default: true
        type: boolean

concurrency:
  group: admin-web-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Admin Web Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./admin-web

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin-web/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Type check
        run: npm run type-check

      - name: ğŸ” Lint
        run: npm run lint

      - name: âœ… Validation summary
        run: |
          echo "ğŸ‰ Admin web validation completed successfully!"
          echo "âœ… Dependencies installed"
          echo "âœ… Type check passed"
          echo "âœ… Lint passed"

  build-and-deploy:
    name: Build and Deploy to Vercel Production
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    environment: production

    defaults:
      run:
        working-directory: ./admin-web

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin-web/package-lock.json

      - name: ğŸ”§ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“ Create production environment file
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SUPABASE_URL=https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
          NODE_ENV=production
          EOF
          echo "âœ… Production environment file created"

      - name: ğŸ”— Link Vercel project
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          vercel link \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --project ${{ secrets.VERCEL_ADMIN_PROJECT_ID }} \
            --yes
          vercel pull \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --yes \
            --environment=production
          echo "âœ… Vercel project linked and settings pulled"

      - name: ğŸ—ï¸ Build with Vercel
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          vercel build \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --prod
          echo "âœ… Build completed"

      - name: ğŸš€ Deploy to Vercel Production
        id: deploy
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          VERCEL_URL=$(vercel deploy \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --prebuilt \
            --prod)
          echo "deployment-url=$VERCEL_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to production: $VERCEL_URL"

      - name: ğŸ§¹ Security cleanup
        if: always()
        run: |
          rm -f .env.local
          echo "âœ… Cleanup completed"

      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ Admin web production deployment completed!"
          if [ "${{ github.event.inputs.deploy_to_vercel }}" != "false" ]; then
            echo "ğŸŒ Production URL: ${{ steps.deploy.outputs.deployment-url }}"
          else
            echo "â­ï¸ Vercel deployment skipped"
          fi
          echo "ğŸ“‹ Configuration:"
          echo "   â€¢ Environment: production"
          echo "   â€¢ Supabase: ${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co"
          echo "   â€¢ Logging: Disabled"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate, build-and-deploy]
    if: always()

    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "ğŸ‰ Admin web production deployment was successful!"
            echo "ğŸŒ URL: ${{ needs.build-and-deploy.outputs.deployment-url }}"
          else
            echo "âŒ Admin web production deployment failed. Check the logs above."
            exit 1
          fi
