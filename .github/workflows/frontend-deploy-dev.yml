name: Frontend Development Deployment

on:
  push:
    branches: [dev]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy-dev.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual triggering
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - development
        - staging
      deploy_to_vercel:
        description: 'Deploy to Vercel'
        required: false
        default: true
        type: boolean

concurrency:
  group: frontend-dev-deploy-${{ github.ref }}
  cancel-in-progress: true  # Cancel previous runs for dev

jobs:
  validate-frontend:
    name: Validate Frontend Code
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get
      
      - name: ğŸ” Analyze code
        run: flutter analyze --fatal-infos
      
      - name: ğŸ§ª Run tests
        run: flutter test --coverage
      
      - name: ğŸ”’ Security scan
        run: |
          echo "ğŸ”’ Running basic security checks..."
          
          # Check for potential security issues in Dart code
          if grep -r "print.*password\|print.*secret\|print.*key\|print.*token" lib/ test/ 2>/dev/null; then
            echo "âš ï¸ Found potential credential logging in print statements"
          fi
          
          # Check for hardcoded URLs in production code
          if grep -r "localhost\|127.0.0.1\|192.168\|10.0.0" lib/ --exclude-dir=test 2>/dev/null; then
            echo "â„¹ï¸ Found localhost references (may be intentional for dev)"
          fi
          
          # Check for TODO/FIXME comments that might indicate security issues
          if grep -r "TODO.*security\|FIXME.*security\|XXX.*security" lib/ 2>/dev/null; then
            echo "â„¹ï¸ Found security-related TODO/FIXME comments"
          fi
          
          echo "âœ… Security scan completed"
      
      - name: âœ… Validation summary
        run: |
          echo "ğŸ‰ Frontend validation completed successfully!"
          echo "âœ… Dependencies installed"
          echo "âœ… Code analysis passed"
          echo "âœ… Tests passed"
          echo "âœ… Security scan completed"

  build-for-development:
    name: Build for Development
    runs-on: ubuntu-latest
    needs: validate-frontend
    timeout-minutes: 20
    
    defaults:
      run:
        working-directory: ./frontend
    
    outputs:
      deployment-url: ${{ steps.deploy.outputs.preview-url }}
      environment: ${{ steps.env-setup.outputs.environment }}
    
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Setup Node.js for Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ”§ Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: ğŸ¯ Determine deployment environment
        id: env-setup
        run: |
          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "DEPLOY_ENV=staging" >> $GITHUB_ENV
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "VERCEL_ALIAS=disciplefy-staging" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.environment }}" = "development" ]; then
            echo "DEPLOY_ENV=development" >> $GITHUB_ENV
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "VERCEL_ALIAS=disciplefy-dev" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=preview" >> $GITHUB_ENV
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "VERCEL_ALIAS=disciplefy-pr-${{ github.event.number || github.run_number }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ¯ Deploying to: ${{ env.DEPLOY_ENV }}"
          echo "ğŸ·ï¸ Vercel alias: ${{ env.VERCEL_ALIAS }}"
      
      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get
      
      - name: ğŸ“ Create development environment configuration
        run: |
          echo "ğŸ“ Creating ${{ env.DEPLOY_ENV }} environment configuration..."
          
          # Create development environment configuration
          cat > lib/core/config/dev_config.dart << EOF
          // Development configuration for ${{ env.DEPLOY_ENV }}
          // This file is generated during CI/CD and should not be committed
          
          class DevConfig {
            static const String environment = '${{ env.DEPLOY_ENV }}';
            static const String apiBaseUrl = 'https://${{ secrets.SUPABASE_DEV_PROJECT_REF || secrets.SUPABASE_PROJECT_REF }}.supabase.co';
            static const String supabaseAnonKey = '${{ secrets.SUPABASE_DEV_ANON_KEY || secrets.SUPABASE_ANON_KEY }}';
            static const bool isDevelopment = true;
            static const bool enableLogging = true;
            static const bool enableDebugMode = true;
          }
          EOF
          
          echo "âœ… Development environment configuration created"
      
      - name: ğŸ—ï¸ Build Flutter web app
        run: |
          echo "ğŸ—ï¸ Building Flutter web app for ${{ env.DEPLOY_ENV }}..."
          
          # Build with development optimizations
          flutter build web \
            --release \
            --web-renderer html \
            --base-href / \
            --dart-define=ENVIRONMENT=${{ env.DEPLOY_ENV }} \
            --dart-define=API_BASE_URL=https://${{ secrets.SUPABASE_DEV_PROJECT_REF || secrets.SUPABASE_PROJECT_REF }}.supabase.co \
            --dart-define=ENABLE_LOGGING=true
          
          echo "ğŸ“Š Build statistics:"
          du -sh build/web
          ls -la build/web/
          
          echo "âœ… Flutter web app built successfully for ${{ env.DEPLOY_ENV }}"
      
      - name: ğŸ“¦ Optimize development build
        run: |
          echo "ğŸ“¦ Optimizing build for ${{ env.DEPLOY_ENV }}..."
          
          # Keep source maps for development/staging (remove only for preview)
          if [ "${{ env.DEPLOY_ENV }}" = "preview" ]; then
            find build/web -name "*.map" -delete
            echo "â„¹ï¸ Source maps removed for preview environment"
          else
            echo "â„¹ï¸ Source maps preserved for ${{ env.DEPLOY_ENV }} environment"
          fi
          
          # Create Vercel configuration for development
          cat > build/web/vercel.json << EOF
          {
            "version": 2,
            "builds": [
              {
                "src": "**/*",
                "use": "@vercel/static"
              }
            ],
            "routes": [
              {
                "src": "/",
                "dest": "/index.html"
              },
              {
                "src": "/(.*)",
                "dest": "/index.html"
              }
            ],
            "headers": [
              {
                "source": "/assets/(.*)",
                "headers": [
                  {
                    "key": "Cache-Control",
                    "value": "public, max-age=31536000, immutable"
                  }
                ]
              }
            ],
            "env": {
              "ENVIRONMENT": "${{ env.DEPLOY_ENV }}"
            }
          }
          EOF
          
          echo "âœ… Build optimization completed for ${{ env.DEPLOY_ENV }}"
      
      - name: ğŸ”— Link Vercel project
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          echo "ğŸ”— Linking to Vercel project..."
          cd build/web
          vercel --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} link --yes --project ${{ secrets.VERCEL_PROJECT_ID }}
          echo "âœ… Vercel project linked"
      
      - name: ğŸš€ Deploy to Vercel
        id: deploy
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          echo "ğŸš€ Deploying to Vercel ${{ env.DEPLOY_ENV }}..."
          
          cd build/web
          
          # Deploy with appropriate settings
          if [ "${{ env.DEPLOY_ENV }}" = "preview" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
            # Preview deployment for PRs
            VERCEL_URL=$(vercel --token ${{ secrets.VERCEL_TOKEN }} --yes | tail -n 1)
            echo "preview-url=$VERCEL_URL" >> $GITHUB_OUTPUT
            echo "deployment-type=preview" >> $GITHUB_OUTPUT
          else
            # Deployment to alias for development/staging
            VERCEL_URL=$(vercel --token ${{ secrets.VERCEL_TOKEN }} --yes)
            vercel --token ${{ secrets.VERCEL_TOKEN }} alias $VERCEL_URL ${{ env.VERCEL_ALIAS }}.vercel.app
            echo "preview-url=https://${{ env.VERCEL_ALIAS }}.vercel.app" >> $GITHUB_OUTPUT
            echo "deployment-type=alias" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… Deployment to Vercel completed"
          echo "ğŸŒ URL: ${{ steps.deploy.outputs.preview-url }}"
      
      - name: ğŸ§ª Test development deployment
        if: ${{ github.event.inputs.deploy_to_vercel != 'false' }}
        run: |
          echo "ğŸ§ª Testing ${{ env.DEPLOY_ENV }} deployment..."
          
          # Wait for deployment to propagate
          sleep 45
          
          DEPLOYMENT_URL="${{ steps.deploy.outputs.preview-url }}"
          
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âš ï¸ No deployment URL found, skipping tests"
            exit 0
          fi
          
          echo "ğŸ” Testing URL: $DEPLOYMENT_URL"
          
          # Test main routes
          ROUTES=("/" "/login" "/onboarding")
          
          for route in "${ROUTES[@]}"; do
            echo "Testing route: $route"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL$route" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Route $route is accessible (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸ Route $route returned HTTP $HTTP_CODE"
            fi
          done
          
          echo "ğŸ‰ ${{ env.DEPLOY_ENV }} deployment tests completed"
      
      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ Frontend deployment to ${{ env.DEPLOY_ENV }} completed!"
          
          if [ "${{ github.event.inputs.deploy_to_vercel }}" != "false" ]; then
            echo "ğŸŒ ${{ env.DEPLOY_ENV }} URL: ${{ steps.deploy.outputs.preview-url }}"
            echo "ğŸ“± Progressive Web App features enabled"
            echo "ğŸ” Routes tested and accessible"
          else
            echo "â­ï¸ Vercel deployment skipped (build-only mode)"
          fi
          
          echo "ğŸ“‹ Configuration:"
          echo "   â€¢ Environment: ${{ env.DEPLOY_ENV }}"
          echo "   â€¢ Logging: Enabled"
          echo "   â€¢ Debug mode: Enabled"
          echo "   â€¢ Source maps: ${{ env.DEPLOY_ENV != 'preview' && 'Preserved' || 'Removed' }}"
      
      - name: ğŸ§¹ Security cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up sensitive files..."
          rm -f lib/core/config/dev_config.dart
          echo "âœ… Cleanup completed"

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: build-for-development
    if: github.event_name == 'pull_request' && github.event.inputs.deploy_to_vercel != 'false'
    
    steps:
      - name: ğŸ’¬ Comment deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ needs.build-for-development.outputs.deployment-url }}';
            const environment = '${{ needs.build-for-development.outputs.environment }}';
            
            if (!deploymentUrl) {
              console.log('No deployment URL available, skipping PR comment');
              return;
            }
            
            const comment = `## ğŸš€ Frontend Development Deployment
            
            **Environment**: \`${environment}\`
            **Status**: âœ… Deployment Successful
            
            ### ğŸ”— Preview URL:
            **[ğŸŒ View Deployment](${deploymentUrl})**
            
            ### ğŸ§ª Test the App:
            - **Homepage**: [${deploymentUrl}](${deploymentUrl})
            - **Login**: [${deploymentUrl}/login](${deploymentUrl}/login)
            - **Onboarding**: [${deploymentUrl}/onboarding](${deploymentUrl}/onboarding)
            
            ### ğŸ› ï¸ Development Features:
            - âœ… Debug mode enabled
            - âœ… Enhanced logging
            - âœ… Development API endpoints
            - âœ… Source maps preserved
            
            **Note**: This is a preview deployment for testing. Changes will be deployed to production when this PR is merged to main.
            
            ---
            *Deployed from commit: ${context.sha.substring(0, 7)}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-frontend, build-for-development]
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          if [ "${{ needs.build-for-development.result }}" = "success" ]; then
            echo "ğŸ‰ Frontend deployment to ${{ needs.build-for-development.outputs.environment }} was successful!"
            
            if [ "${{ github.event.inputs.deploy_to_vercel }}" != "false" ]; then
              echo "ğŸŒ ${{ needs.build-for-development.outputs.environment }} app is now live"
              echo "ğŸ“± Progressive Web App features are enabled"
              echo "ğŸ” All routes tested and accessible"
            else
              echo "ğŸ—ï¸ Build completed successfully (deploy skipped)"
            fi
            
            echo "ğŸ§ª Ready for testing and validation"
          else
            echo "âŒ Frontend deployment failed. Check the logs above."
            exit 1
          fi