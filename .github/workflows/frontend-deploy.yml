name: Deploy Frontend to Production

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: frontend-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-frontend:
    name: Validate Frontend Code
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get
      
      - name: ğŸ” Analyze code
        run: flutter analyze
      
      - name: ğŸ§ª Run tests
        run: flutter test --coverage
      
      - name: âœ… Validation summary
        run: |
          echo "ğŸ‰ Frontend validation completed successfully!"
          echo "âœ… Dependencies installed"
          echo "âœ… Code analysis passed"
          echo "âœ… Tests passed"

  build-and-deploy:
    name: Build and Deploy to Vercel
    runs-on: ubuntu-latest
    needs: validate-frontend
    timeout-minutes: 20
    environment: production
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Setup Node.js for Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ”§ Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build Flutter web app
        run: |
          echo "ğŸ—ï¸ Building Flutter web app for production..."
          flutter build web --release --base-href /
          
          echo "ğŸ“Š Build statistics:"
          du -sh build/web
          ls -la build/web/
          
          echo "âœ… Flutter web app built successfully"
      
      - name: ğŸ“¦ Optimize build
        run: |
          echo "ğŸ“¦ Optimizing build for production..."
          
          # Remove source maps for production
          find build/web -name "*.map" -delete
          
          # Create clean deployment directory to avoid nested structure issues
          rm -rf vercel-deploy
          mkdir -p vercel-deploy
          
          # Copy all build files to clean deployment directory
          cp -r build/web/* vercel-deploy/
          
          # Create Vercel configuration for production (static deployment only)
          cat > vercel-deploy/vercel.json << EOF
          {
            "version": 2,
            "buildCommand": null,
            "outputDirectory": ".",
            "builds": [
              {
                "src": "**/*",
                "use": "@vercel/static"
              }
            ],
            "routes": [
              {
                "src": "/",
                "dest": "/index.html"
              },
              {
                "src": "/(.*)",
                "dest": "/index.html"
              }
            ],
            "headers": [
              {
                "source": "/assets/(.*)",
                "headers": [
                  {
                    "key": "Cache-Control",
                    "value": "public, max-age=31536000, immutable"
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "âœ… Build optimization completed"
      
      - name: ğŸ”— Link Vercel project
        run: |
          echo "ğŸ”— Linking to Vercel project..."
          vercel --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} link --yes --project ${{ secrets.VERCEL_PROJECT_ID }} --cwd vercel-deploy
      
      - name: ğŸš€ Deploy to Vercel
        run: |
          echo "ğŸš€ Deploying to Vercel production..."
          
          # Deploy from clean deployment directory using --cwd flag
          vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes --cwd vercel-deploy
          
          echo "âœ… Deployment to Vercel completed"
      
      - name: ğŸ§ª Test production deployment
        run: |
          echo "ğŸ§ª Testing production deployment..."
          
          # Wait a moment for deployment to propagate
          sleep 30
          
          # Test main routes
          ROUTES=("/" "/login" "/onboarding")
          
          for route in "${ROUTES[@]}"; do
            echo "Testing route: $route"
            if curl -f -s "https://disciplefy.vercel.app$route" > /dev/null; then
              echo "âœ… Route $route is accessible"
            else
              echo "âš ï¸ Route $route test failed"
            fi
          done
          
          echo "ğŸ‰ Production deployment tests completed"
      
      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ Frontend deployment completed successfully!"
          echo "ğŸŒ Production URL: https://disciplefy.vercel.app"
          echo "ğŸ“± Progressive Web App ready"
          echo "ğŸ” All routes tested and accessible"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-frontend, build-and-deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "ğŸ‰ Frontend deployment to production was successful!"
            echo "ğŸŒ App is now live at: https://disciplefy.vercel.app"
            echo "ğŸ“± Progressive Web App features are enabled"
            echo "ğŸ”„ All routes are working correctly"
          else
            echo "âŒ Frontend deployment failed. Check the logs above."
            exit 1
          fi