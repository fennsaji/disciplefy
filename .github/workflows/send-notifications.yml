name: Send Push Notifications (Production)

on:
  schedule:
    # ============================================================================
    # Unified Schedule - Each cron appears exactly once
    # Job-level if-conditions determine which notifications run at each hour
    # ============================================================================
    #
    # Hour mapping (all notifications that run at each UTC hour):
    # UTC 0:  Daily Verse (6 AM UTC+6), Memory Verse Reminder (9 AM UTC+9)
    # UTC 2:  Recommended Topic (8 AM UTC+6)
    # UTC 3:  Daily Verse (6 AM UTC+3), Memory Verse Reminder (9 AM UTC+6)
    # UTC 5:  Recommended Topic (8 AM UTC+3)
    # UTC 6:  Daily Verse (6 AM UTC+0), Memory Verse Reminder (9 AM UTC+3)
    # UTC 8:  Recommended Topic (8 AM UTC+0)
    # UTC 9:  Daily Verse (6 AM UTC-3), Memory Verse Reminder (9 AM UTC+0)
    # UTC 11: Recommended Topic (8 AM UTC-3)
    # UTC 12: Daily Verse (6 AM UTC-6), Memory Verse Reminder (9 AM UTC-3)
    # UTC 14: Recommended Topic (8 AM UTC-6)
    # UTC 15: Daily Verse (6 AM UTC-9), Memory Verse Reminder (9 AM UTC-6)
    # UTC 17: Recommended Topic (8 AM UTC-9)
    # UTC 18: Daily Verse (6 AM UTC+12), Memory Verse Reminder (9 AM UTC-9)
    # UTC 20: Recommended Topic (8 AM UTC+12)
    # UTC 21: Daily Verse (6 AM UTC+9), Memory Verse Reminder (9 AM UTC+12)
    # UTC 23: Recommended Topic (8 AM UTC+9)
    #
    # ============================================================================

    # Hourly trigger for Streak Reminders (user's preferred time)
    # Also covers all notification hours - job if-conditions filter appropriately
    - cron: '0 * * * *'   # Every hour at :00 minutes

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Notification type to send'
        required: true
        type: choice
        options:
          - daily_verse
          - recommended_topic
          - streak_reminder
          - memory_verse_reminder
          - all

jobs:
  # ==========================================================================
  # Job 1: Send Daily Verse Notifications
  # ==========================================================================
  send-daily-verse:
    runs-on: ubuntu-latest
    name: Send Daily Verse Notifications (Prod)

    # Run on schedule OR manual dispatch
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.notification_type == 'daily_verse' ||
        github.event.inputs.notification_type == 'all'))

    steps:
      - name: Check if this hour should run Daily Verse
        id: should_run
        run: |
          # Daily Verse should run every 3 hours: 0, 3, 6, 9, 12, 15, 18, 21
          current_hour=$(date -u +%H)
          if [[ $current_hour -eq 0 || $current_hour -eq 3 || $current_hour -eq 6 || $current_hour -eq 9 || $current_hour -eq 12 || $current_hour -eq 15 || $current_hour -eq 18 || $current_hour -eq 21 ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Should run Daily Verse at UTC hour $current_hour"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping Daily Verse at UTC hour $current_hour (not a scheduled hour)"
          fi

      - name: Send Daily Verse Push Notifications (Prod)
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "Triggering Daily Verse notification Edge Function (Production)..."

          response=$(curl -X POST \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/send-daily-verse-notification" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response Code: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Daily Verse notifications sent successfully (Production)"
            exit 0
          else
            echo "❌ Failed to send Daily Verse notifications (Production)"
            exit 1
          fi

      - name: Log Execution
        if: always()
        run: |
          echo "Job Status: ${{ job.status }}"
          echo "Should Run: ${{ steps.should_run.outputs.should_run }}"
          echo "Triggered at: $(date -u)"
          echo "Environment: Production"
          echo "Notification Type: Daily Verse (6 AM)"

  # ==========================================================================
  # Job 2: Send Recommended Topic Notifications
  # ==========================================================================
  send-recommended-topic:
    runs-on: ubuntu-latest
    name: Send Recommended Topic Notifications (Prod)

    # Run on schedule OR manual dispatch
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.notification_type == 'recommended_topic' ||
        github.event.inputs.notification_type == 'all'))

    steps:
      - name: Check if this hour should run Recommended Topic
        id: should_run
        run: |
          # Recommended Topic should run every 3 hours: 2, 5, 8, 11, 14, 17, 20, 23
          current_hour=$(date -u +%H)
          if [[ $current_hour -eq 2 || $current_hour -eq 5 || $current_hour -eq 8 || $current_hour -eq 11 || $current_hour -eq 14 || $current_hour -eq 17 || $current_hour -eq 20 || $current_hour -eq 23 ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Should run Recommended Topic at UTC hour $current_hour"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping Recommended Topic at UTC hour $current_hour (not a scheduled hour)"
          fi

      - name: Send Recommended Topic Push Notifications (Prod)
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "Triggering Recommended Topic notification Edge Function (Production)..."

          response=$(curl -X POST \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/send-recommended-topic-notification" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response Code: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Recommended Topic notifications sent successfully (Production)"
            exit 0
          else
            echo "❌ Failed to send Recommended Topic notifications (Production)"
            exit 1
          fi

      - name: Log Execution
        if: always()
        run: |
          echo "Job Status: ${{ job.status }}"
          echo "Should Run: ${{ steps.should_run.outputs.should_run }}"
          echo "Triggered at: $(date -u)"
          echo "Environment: Production"
          echo "Notification Type: Recommended Topic (8 AM)"

  # ==========================================================================
  # Job 3: Send Streak Reminder Notifications
  # ==========================================================================
  send-streak-reminder:
    runs-on: ubuntu-latest
    name: Send Streak Reminder Notifications (Prod)

    # Run every hour (users set their own reminder time)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.notification_type == 'streak_reminder' ||
        github.event.inputs.notification_type == 'all'))

    steps:
      - name: Send Streak Reminder Push Notifications (Prod)
        run: |
          echo "Triggering Streak Reminder notification Edge Function (Production)..."

          response=$(curl -X POST \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/send-streak-reminder-notification" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Streak Reminder notifications sent successfully (Production)"
            exit 0
          else
            echo "❌ Failed to send Streak Reminder notifications (Production)"
            exit 1
          fi

      - name: Log Execution
        if: always()
        run: |
          echo "Job Status: ${{ job.status }}"
          echo "Triggered at: $(date -u)"
          echo "Environment: Production"
          echo "Notification Type: Streak Reminder (Hourly)"

  # ==========================================================================
  # Job 4: Send Memory Verse Reminder Notifications
  # ==========================================================================
  send-memory-verse-reminder:
    runs-on: ubuntu-latest
    name: Send Memory Verse Reminder Notifications (Prod)

    # Run on schedule OR manual dispatch
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.notification_type == 'memory_verse_reminder' ||
        github.event.inputs.notification_type == 'all'))

    steps:
      - name: Check if this hour should run Memory Verse Reminder
        id: should_run
        run: |
          # Memory Verse Reminder should run every 3 hours: 0, 3, 6, 9, 12, 15, 18, 21
          current_hour=$(date -u +%H)
          if [[ $current_hour -eq 0 || $current_hour -eq 3 || $current_hour -eq 6 || $current_hour -eq 9 || $current_hour -eq 12 || $current_hour -eq 15 || $current_hour -eq 18 || $current_hour -eq 21 ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Should run Memory Verse Reminder at UTC hour $current_hour"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping Memory Verse Reminder at UTC hour $current_hour (not a scheduled hour)"
          fi

      - name: Send Memory Verse Reminder Push Notifications (Prod)
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "Triggering Memory Verse Reminder notification Edge Function (Production)..."

          response=$(curl -X POST \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/send-memory-verse-notification?type=reminder" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response Code: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Memory Verse Reminder notifications sent successfully (Production)"
            exit 0
          else
            echo "❌ Failed to send Memory Verse Reminder notifications (Production)"
            exit 1
          fi

      - name: Log Execution
        if: always()
        run: |
          echo "Job Status: ${{ job.status }}"
          echo "Should Run: ${{ steps.should_run.outputs.should_run }}"
          echo "Triggered at: $(date -u)"
          echo "Environment: Production"
          echo "Notification Type: Memory Verse Reminder (9 AM)"

  # ==========================================================================
  # Job 5: Monitor Notification Health
  # ==========================================================================
  monitor-health:
    runs-on: ubuntu-latest
    name: Monitor Notification System Health (Prod)
    needs: [send-daily-verse, send-recommended-topic, send-streak-reminder, send-memory-verse-reminder]
    if: always()

    steps:
      - name: Check Job Results
        run: |
          echo "Daily Verse Job Status: ${{ needs.send-daily-verse.result }}"
          echo "Recommended Topic Job Status: ${{ needs.send-recommended-topic.result }}"
          echo "Streak Reminder Job Status: ${{ needs.send-streak-reminder.result }}"
          echo "Memory Verse Reminder Job Status: ${{ needs.send-memory-verse-reminder.result }}"
          echo "Memory Verse Overdue Job Status: ${{ needs.send-memory-verse-overdue.result }}"

          if [ "${{ needs.send-daily-verse.result }}" == "failure" ] || \
             [ "${{ needs.send-recommended-topic.result }}" == "failure" ] || \
             [ "${{ needs.send-streak-reminder.result }}" == "failure" ] || \
             [ "${{ needs.send-memory-verse-reminder.result }}" == "failure" ] || \
             [ "${{ needs.send-memory-verse-overdue.result }}" == "failure" ]; then
            echo "⚠️ One or more notification jobs failed in Production"
            echo "Please check Supabase Edge Function logs for details"
            exit 1
          else
            echo "✅ All notification jobs completed successfully (Production)"
          fi
